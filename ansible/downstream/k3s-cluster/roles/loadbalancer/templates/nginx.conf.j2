# Mabye on other distros
#load_module /usr/lib/nginx/modules/ngx_stream_module.so;

# openSUSE specific path
load_module /usr/lib64/nginx/modules/ngx_stream_module.so;

events {}

stream {
    upstream etcd_nodes {
        server {{ hostvars[groups['etcd'][0]]['ansible_default_ipv4']['address'] }}:6443 max_fails=3 fail_timeout=5s;
        server {{ hostvars[groups['etcd'][1]]['ansible_default_ipv4']['address'] }}:6443 max_fails=3 fail_timeout=5s;
        server {{ hostvars[groups['etcd'][2]]['ansible_default_ipv4']['address'] }}:6443 max_fails=3 fail_timeout=5s;
    }

    server {
        listen 6444;
        proxy_pass etcd_nodes;
    }

    upstream control-plane_nodes {
        server {{ hostvars[groups['control_plane'][0]]['ansible_default_ipv4']['address'] }}:6443 max_fails=3 fail_timeout=5s;
        server {{ hostvars[groups['control_plane'][1]]['ansible_default_ipv4']['address'] }}:6443 max_fails=3 fail_timeout=5s;
    }

    server {
        listen 6443;
        proxy_pass control-plane_nodes;
    }
}