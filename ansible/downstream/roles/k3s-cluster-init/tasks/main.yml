---
# If airgapped, all K3s artifacts are already on the node.
- name: Download K3s install script
  when: airgap_dir is undefined
  ansible.builtin.get_url:
    url: https://get.k3s.io/
    timeout: 120
    dest: /usr/local/bin/k3s-install.sh
    owner: root
    group: root
    mode: 0755

- name: Download K3s binary
  when: airgap_dir is undefined
  ansible.builtin.command:
    cmd: /usr/local/bin/k3s-install.sh
  environment:
    INSTALL_K3S_SKIP_START: "true"
    INSTALL_K3S_VERSION: "{{ k3s_version }}"
  changed_when: true

- name: Setup optional config file [etcd]
  when: etcd_config_yaml is defined and inventory_hostname in groups['etcd']
  block:
    - name: Make config directory
      ansible.builtin.file:
        path: "/etc/rancher/k3s"
        mode: 0750
        state: directory
    - name: Copy config values
      ansible.builtin.copy:
        content: "{{ etcd_config_yaml }}"
        dest: "/etc/rancher/k3s/config.yaml"
        mode: 0640

- name: Setup optional config file [server]
  when: server_config_yaml is defined and inventory_hostname in groups['server']
  block:
    - name: Make config directory
      ansible.builtin.file:
        path: "/etc/rancher/k3s"
        mode: 0750
        state: directory
    - name: Copy config values
      ansible.builtin.copy:
        content: "{{ server_config_yaml }}"
        dest: "/etc/rancher/k3s/config.yaml"
        mode: 0640

- name: Stop previous runs of k3s-init
  ansible.builtin.systemd:
    name: k3s-init
    state: stopped
  failed_when: false

- name: Reload the systemd daemon
  ansible.builtin.systemd:
    daemon_reload: yes

#- name: Reset the failed state of the k3s-init
#  ansible.builtin.command:
#    cmd: systemctl reset-failed k3s-init

- name: Init cluster on etcd nodes
  ansible.builtin.command:
    cmd: "systemd-run -p RestartSec=2 \
                      -p Restart=on-failure \
                      --unit=k3s-init \
                      /usr/local/bin/k3s server {{ etcd_init_args }}"
  when: inventory_hostname in groups['etcd']

- name: Wait for node-token
  ansible.builtin.wait_for:
    path: "{{ k3s_server_location }}/server/node-token"
  when: inventory_hostname == groups['etcd'][0]
  tags:
    - etcd-recover
    - restore
    - agent-recover

- name: Register node-token file access mode
  ansible.builtin.stat:
    path: "{{ k3s_server_location }}/server/node-token"
  register: p
  when: inventory_hostname == groups['etcd'][0]
  tags:
    - etcd-recover

- name: Change file access node-token
  ansible.builtin.file:
    path: "{{ k3s_server_location }}/server/node-token"
    mode: "g+rx,o+rx"
  when: inventory_hostname == groups['etcd'][0]
  tags:
    - etcd-recover

- name: Read node-token from etcd
  ansible.builtin.slurp:
    path: "{{ k3s_server_location }}/server/node-token"
  register: node_token
  when: inventory_hostname == groups['etcd'][0]
  tags:
    - etcd-recover
    - restore
    - agent-recover

- name: Store etcd node-token
  ansible.builtin.set_fact:
    token: "{{ node_token.content | b64decode | regex_replace('\n', '') }}"
  when: inventory_hostname == groups['etcd'][0]
  tags:
    - etcd-recover
    - restore
    - agent-recover

- name: Restore node-token file access
  ansible.builtin.file:
    path: "{{ k3s_server_location }}/server/node-token"
    mode: "{{ p.stat.mode }}"
  when: inventory_hostname == groups['etcd'][0]
  tags:
    - etcd-recover

- name: "Wait for first etcd node port"
  ansible.builtin.wait_for:
    host: "{{ hostvars[groups['etcd'][0]].flannel_node_ip }}"
    port: 6443
    delay: 10
  when: inventory_hostname in groups['server']

- name: Init cluster on control-plane nodes
  ansible.builtin.command:
    cmd: "systemd-run -p RestartSec=2 \
                      -p Restart=on-failure \
                      --unit=k3s-init \
                      /usr/local/bin/k3s server {{ server_init_args }}"
  when: inventory_hostname in groups['server']

- name: Verify that all etcd nodes actually joined
  ansible.builtin.command:
    cmd: /usr/local/bin/k3s kubectl get nodes -l "node-role.kubernetes.io/etcd=true" -o=jsonpath="{.items[*].metadata.name}"
  register: nodes
  until: nodes.rc == 0 and (nodes.stdout.split() | length) == (groups['etcd'] | length)
  retries: "{{ retry_count | default(20) }}"
  delay: 10
  when: inventory_hostname in groups['server']
  changed_when: false

- name: Verify that all control-plane nodes actually joined
  ansible.builtin.command:
    cmd: /usr/local/bin/k3s kubectl get nodes -l "node-role.kubernetes.io/control-plane=true" -o=jsonpath="{.items[*].metadata.name}"
  register: nodes
  until: nodes.rc == 0 and (nodes.stdout.split() | length) == (groups['server'] | length)
  retries: "{{ retry_count | default(20) }}"
  delay: 10
  when: inventory_hostname in groups['server']
  changed_when: false
